version: '3.8'

services:
  scraper:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: qrent-scraper
    
    # 内存限制
    deploy:
      resources:
        limits:
          memory: 3G
        reservations:
          memory: 1G
    
    # 环境变量
    environment:
      - PYTHONUNBUFFERED=1
      - DISPLAY=:99
      # 数据库配置 (可选)
      - DB_HOST=${DB_HOST:-localhost}
      - DB_USER=${DB_USER:-root}
      - DB_PASSWORD=${DB_PASSWORD:-}
      - DB_DATABASE=${DB_DATABASE:-qrent}
      # API Keys (可选)
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY:-}
      - GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY:-}
      # 输出目录
      - OUTPUT_DIR=/app/output
    
    # 挂载目录
    volumes:
      # 输出文件
      - ./output:/app/output
      # 日志
      - ./logs:/app/logs
      # 浏览器配置 (直接使用本地 profile)
      - ./domain_profile:/app/domain_profile
      - ./rea_profile:/app/rea_profile
      # 环境变量文件
      - ./.env:/app/.env:ro
    
    # 网络
    networks:
      - qrent-network
    
    # 重启策略
    restart: "no"
    
    # 共享内存 (Playwright/Xvfb 需要)
    shm_size: '2gb'
    
    # 安全设置 (Xvfb 需要)
    security_opt:
      - seccomp:unconfined
    
    # 允许 X11
    privileged: false

networks:
  qrent-network:
    driver: bridge
